name: ğŸ“‹ Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [master, dev, develop]

env:
  NODE_VERSION: "18.x"

jobs:
  # ğŸ“‹ PR Info
  pr-info:
    name: ğŸ“‹ Pull Request Information
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‹ Display PR Info
        run: |
          echo "ğŸ“‹ Pull Request Information"
          echo "=========================="
          echo "ğŸ”– Title: ${{ github.event.pull_request.title }}"
          echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
          echo "ğŸŒ¿ Source: ${{ github.event.pull_request.head.ref }}"
          echo "ğŸ¯ Target: ${{ github.event.pull_request.base.ref }}"
          echo "ğŸ“Š Files Changed: ${{ github.event.pull_request.changed_files }}"
          echo "â• Additions: ${{ github.event.pull_request.additions }}"
          echo "â– Deletions: ${{ github.event.pull_request.deletions }}"

  # ğŸ” Code Quality Check
  code-quality:
    name: ğŸ” Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“‹ Install Dependencies
        run: |
          cd packages/backend && (npm ci || npm install)
          cd ../frontend && (npm ci || npm install)

      - name: ğŸ” Check for Large Files
        run: |
          echo "ğŸ” Checking for large files..."
          find . -name "node_modules" -prune -o -type f -size +10M -print | head -10

      - name: ğŸ” Check Package Vulnerabilities
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for known vulnerabilities..."
          cd packages/backend && npm audit --audit-level=high || true
          cd ../frontend && npm audit --audit-level=high || true

  # ğŸ§ª Quick Tests
  quick-tests:
    name: ğŸ§ª Quick Validation Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“‹ Install Dependencies
        run: |
          cd packages/backend && (npm ci || npm install)
          cd ../frontend && (npm ci || npm install)

      - name: ğŸ” Backend Lint Check
        run: |
          cd packages/backend
          npm run lint || echo "âš ï¸ Linting issues found"

      - name: ğŸ” Frontend Lint Check
        run: |
          cd packages/frontend
          npm run lint || echo "âš ï¸ Linting issues found"

      - name: ğŸ” TypeScript Compilation Check
        run: |
          cd packages/backend
          npx tsc --noEmit || echo "âš ï¸ TypeScript compilation issues in backend"
          cd ../frontend
          npm run type-check || echo "âš ï¸ TypeScript compilation issues in frontend"

  # ğŸ—ï¸ Build Verification
  build-check:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: [quick-tests]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“‹ Install Dependencies
        run: |
          cd packages/backend && (npm ci || npm install)
          cd ../frontend && (npm ci || npm install)

      - name: ğŸ—ï¸ Test Backend Build
        run: |
          cd packages/backend
          npm run build

      - name: ğŸ—ï¸ Test Frontend Build
        run: |
          cd packages/frontend
          npm run build

      - name: âœ… Build Success
        run: |
          echo "âœ… All builds completed successfully!"
          echo "ğŸ‰ PR is ready for review"

  # ğŸ“Š PR Summary
  pr-summary:
    name: ğŸ“Š Pull Request Summary
    runs-on: ubuntu-latest
    needs: [pr-info, code-quality, quick-tests, build-check]
    if: always()

    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "ğŸ“Š Pull Request Validation Summary"
          echo "================================="

          # Check results
          code_quality="${{ needs.code-quality.result }}"
          quick_tests="${{ needs.quick-tests.result }}"
          build_check="${{ needs.build-check.result }}"

          echo "ğŸ” Code Quality: $code_quality"
          echo "ğŸ§ª Quick Tests: $quick_tests"
          echo "ğŸ—ï¸ Build Check: $build_check"

          if [[ "$code_quality" == "success" && "$quick_tests" == "success" && "$build_check" == "success" ]]; then
            echo ""
            echo "âœ… PR Validation PASSED"
            echo "ğŸ‰ Ready for review and merge!"
          else
            echo ""
            echo "âŒ PR Validation FAILED"
            echo "ğŸ” Please fix the issues above before requesting review"
          fi
